{% extends 'core/base.html' %}
{% load core_extras %}

{% block content %}
{% if stats %}
<!-- Stats Ribbon (Injected via extra_context) -->
<style>
    /* Stats Ribbon Styles (Copied for consistency) */
    .stats-ribbon {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding: 16px 0;
        margin-bottom: 16px;
        -webkit-overflow-scrolling: touch;
    }

    .stats-ribbon::-webkit-scrollbar {
        display: none;
    }

    @media (min-width: 1024px) {
        .stats-ribbon {
            flex-wrap: wrap;
            overflow-x: visible;
        }
    }

    .stat-chip {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 24px;
        padding: 10px 18px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        font-size: 0.85rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .stat-chip .emoji {
        font-size: 1rem;
    }

    .stat-chip.stat-green {
        background: #065F46;
        border-color: #10B981;
        color: #D1FAE5;
    }

    .stat-chip.stat-orange {
        background: #92400E;
        border-color: #F59E0B;
        color: #FEF3C7;
    }

    .stat-chip.stat-red {
        background: #991B1B;
        border-color: #EF4444;
        color: #FEE2E2;
    }
</style>
<div class="stats-ribbon">
    <div class="stat-chip"><span class="emoji">üè¨</span> {{ stats.total_facilities }} Birim</div>
    <div class="stat-chip"><span class="emoji">üë•</span> {{ stats.total_workers }} √áalƒ±≈üan</div>
    <div
        class="stat-chip {% if stats.training_pct >= 90 %}stat-green{% elif stats.training_pct >= 70 %}stat-orange{% else %}stat-red{% endif %}">
        <span class="emoji">üéì</span> %{{ stats.training_pct }} Eƒüitim
    </div>
    <div
        class="stat-chip {% if stats.exam_pct >= 90 %}stat-green{% elif stats.exam_pct >= 70 %}stat-orange{% else %}stat-red{% endif %}">
        <span class="emoji">‚ù§Ô∏è‚Äçü©π</span> %{{ stats.exam_pct }} Muayene
    </div>
    <div class="stat-chip"><span class="emoji">üöë</span> {{ stats.first_aid_count }} ƒ∞lk Yardƒ±m</div>
</div>
{% endif %}
<div class="row mb-3">
    <div class="col d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h2>{{ title }}</h2>
            {% if filter_config %}
            <button class="btn btn-outline-secondary ms-3" type="button" data-bs-toggle="collapse"
                data-bs-target="#filterCollapse" aria-expanded="false">
                <i class="bi bi-funnel"></i> Filtrele
            </button>
            {% endif %}
        </div>

        <!-- Desktop Actions -->
        <div class="d-none d-md-block">
            {% if export_url_name %}
            <div class="btn-group me-2">
                <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="bi bi-download"></i> Dƒ±≈üa Aktar
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item"
                            href="{% url export_url_name %}?format=csv{% for key, value in request.GET.items %}{% if key != 'format' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">CSV
                            ƒ∞ndir</a></li>
                    <li><a class="dropdown-item"
                            href="{% url export_url_name %}?format=xlsx{% for key, value in request.GET.items %}{% if key != 'format' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Excel
                            ƒ∞ndir</a></li>
                </ul>
            </div>
            {% endif %}

            {% if import_url_name %}
            <a href="{% url import_url_name %}" class="btn btn-outline-primary me-2">
                <i class="bi bi-upload"></i> ƒ∞√ße Aktar
            </a>
            {% endif %}

            {% if bulk_delete_url_name %}
            <button type="button" class="btn btn-danger me-2" id="delete-selected-btn" disabled>
                <i class="bi bi-trash"></i> Se√ßilenleri Sil
            </button>
            {% endif %}

            {% if create_url_name %}
            <a href="{% url create_url_name %}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Yeni Ekle
            </a>
            {% endif %}
        </div>

        <!-- Mobile Actions (Dropdown) -->
        <div class="d-md-none">
            <div class="dropdown">
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% if export_url_name %}
                    <li>
                        <h6 class="dropdown-header">Dƒ±≈üa Aktar</h6>
                    </li>
                    <li><a class="dropdown-item"
                            href="{% url export_url_name %}?format=csv{% for key, value in request.GET.items %}{% if key != 'format' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i
                                class="bi bi-filetype-csv"></i> CSV ƒ∞ndir</a></li>
                    <li><a class="dropdown-item"
                            href="{% url export_url_name %}?format=xlsx{% for key, value in request.GET.items %}{% if key != 'format' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i
                                class="bi bi-file-earmark-spreadsheet"></i> Excel ƒ∞ndir</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    {% endif %}

                    {% if import_url_name %}
                    <li><a class="dropdown-item" href="{% url import_url_name %}"><i class="bi bi-upload"></i> ƒ∞√ße
                            Aktar</a></li>
                    {% endif %}

                    {% if bulk_delete_url_name %}
                    <!-- Note: Bulk delete is tricky on mobile card view since checkboxes might be hidden or awkward. Keeping it simple or relying on individual delete.
                         For now, we can show a link but it requires JS interaction with hidden checkboxes.
                         Let's omit Bulk Delete from mobile dropdown for safety/simplicity unless critical. -->
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Mobile FAB -->
{% if create_url_name %}
<a href="{% url create_url_name %}" class="btn btn-primary fab-btn d-md-none">
    <i class="bi bi-plus-lg"></i>
</a>
{% endif %}

{% if filter_config %}
<div class="card mb-3 collapse" id="filterCollapse">
    <div class="card-body">
        <form method="get" class="row g-3">
            {% for config in filter_config %}
            <div class="col-md-3">
                <label for="filter-{{ config.field }}" class="form-label">{{ config.label|default:config.field|title
                    }}</label>

                {% if config.type == 'select' %}
                <select name="{{ config.field }}" id="filter-{{ config.field }}" class="form-select">
                    <option value="">T√ºm√º</option>
                    {% for opt_val, opt_label in config.options %}
                    <option value="{{ opt_val }}" {% if config.value == opt_val %}selected{% endif %}>{{ opt_label }}
                    </option>
                    {% endfor %}
                </select>
                {% elif config.type == 'date' %}
                <div class="input-group">
                    <input type="date" name="{{ config.field }}_min" class="form-control"
                        value="{{ config.value_min|default:'' }}" placeholder="Ba≈ülangƒ±√ß" title="Ba≈ülangƒ±√ß Tarihi">
                    <span class="input-group-text">-</span>
                    <input type="date" name="{{ config.field }}_max" class="form-control"
                        value="{{ config.value_max|default:'' }}" placeholder="Biti≈ü" title="Biti≈ü Tarihi">
                </div>
                {% else %}
                <input type="text" name="{{ config.field }}" id="filter-{{ config.field }}" class="form-control"
                    value="{{ config.value|default:'' }}" placeholder="Ara...">
                {% endif %}
            </div>
            {% endfor %}
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary me-2">Filtrele</button>
                <a href="{{ request.path }}" class="btn btn-outline-secondary">Temizle</a>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Mobile List View (iOS Style) -->
<div class="ios-list-group d-md-none">
    {% for item in items %}
    <div class="ios-list-item" onclick="toggleIosDetails(this)">
        <div class="ios-item-header">
            <div class="ios-item-title">
                {% with first_field=fields.0.0 %}
                {{ item|getattr:first_field }}
                {% endwith %}
            </div>
            <div class="ios-badges">
                {% if mobile_config %}
                {% for badge in mobile_config.badge_fields %}
                {% with val=item|getattr:badge.field %}
                {% if badge.condition_gt %}
                {% if val > badge.condition_gt %}
                <span class="ios-badge"><i class="bi {{ badge.icon }}"></i> {{ val }}</span>
                {% endif %}
                {% else %}
                <span class="ios-badge"><i class="bi {{ badge.icon }}"></i> {{ val }}</span>
                {% endif %}
                {% endwith %}
                {% endfor %}
                {% endif %}
                <i class="bi bi-chevron-down ios-chevron"></i>
            </div>
        </div>
        <div class="ios-item-details">
            {% for field_name, field_label in fields %}
            <div class="ios-detail-row">
                <span class="ios-detail-label">{{ field_label }}</span>
                <span>{{ item|getattr:field_name|safe }}</span>
            </div>
            {% endfor %}
            {% if update_url_name %}
            <a href="{% url update_url_name item.pk %}" class="ios-edit-btn">Edit Details</a>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="p-4 text-center text-muted">Kayƒ±t bulunamadƒ±.</div>
    {% endfor %}
</div>

<!-- Desktop Table View -->
<div class="card d-none d-md-block">
    <div class="card-body p-0">
        <form method="post" action="{% if bulk_delete_url_name %}{% url bulk_delete_url_name %}{% endif %}"
            id="bulk-delete-form">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            {% if bulk_delete_url_name %}
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="select-all">
                            </th>
                            {% endif %}
                            {% for field_name, field_label in fields %}
                            <th>
                                <a href="?{% url_replace sort=field_name %}{% if current_sort == field_name %}&sort=-{{ field_name }}{% endif %}"
                                    class="text-decoration-none text-dark">
                                    {{ field_label }}
                                    {% if current_sort == field_name %}<i class="bi bi-arrow-down"></i>{% elif
                                    current_sort == '-'|add:field_name %}<i class="bi bi-arrow-up"></i>{% endif %}
                                </a>
                            </th>
                            {% endfor %}
                            <th style="width: 100px;">ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            {% if bulk_delete_url_name %}
                            <td>
                                <input type="checkbox" class="form-check-input item-checkbox" name="selected_items"
                                    value="{{ item.pk }}">
                            </td>
                            {% endif %}
                            {% for field_name, field_label in fields %}
                            <td class="item-data" data-label="{{ field_label }}">
                                {% with value=item|getattr:field_name %}
                                {{ value|safe }}
                                {% endwith %}
                            </td>
                            {% endfor %}
                            <td>
                                {% if extra_actions %}
                                {% for action in extra_actions %}
                                <a href="{% url action.url_name %}?{{ action.query_param }}={{ item.pk }}"
                                    class="btn {{ action.btn_class }} me-1" title="{{ action.label }}">
                                    <i class="bi {{ action.icon }}"></i>
                                </a>
                                {% endfor %}
                                {% endif %}
                                {% if update_url_name %}
                                <a href="{% url update_url_name item.pk %}" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{{ fields|length|add:'2' }}" class="text-center py-4 text-muted">
                                Kayƒ±t bulunamadƒ±.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<!-- Caution Note Modal -->
<div class="modal fade" id="cautionNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Uyarƒ± Notu D√ºzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="caution-note-form" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-caution-note" class="form-label">Not</label>
                        <textarea class="form-control" id="modal-caution-note" name="caution_note" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="action" value="delete" class="btn btn-danger me-auto">Sil</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" name="action" value="save" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Silme Onayƒ±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>A≈üaƒüƒ±daki kayƒ±tlarƒ± silmek √ºzeresiniz. Bu i≈ülem geri alƒ±namaz.</p>
                <ul id="delete-confirmation-list" class="list-group list-group-flush mb-3">
                    <!-- Items will be populated here -->
                </ul>
                <p class="fw-bold text-danger">Onaylƒ±yor musunuz?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Evet, Sil</button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleIosDetails(element) {
        const details = element.querySelector('.ios-item-details');
        const chevron = element.querySelector('.ios-chevron');
        if (details.style.display === 'block') {
            details.style.display = 'none';
            chevron.style.transform = 'rotate(0deg)';
            element.querySelector('.ios-item-header').style.backgroundColor = '';
        } else {
            details.style.display = 'block';
            chevron.style.transform = 'rotate(180deg)';
            // Highlight active state
            // element.querySelector('.ios-item-header').style.backgroundColor = '#E5E5EA';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Caution Icon Handler
        const cautionNoteModalEl = document.getElementById('cautionNoteModal');
        if (cautionNoteModalEl) {
            const cautionNoteModal = new bootstrap.Modal(cautionNoteModalEl);
            const modalNoteInput = document.getElementById('modal-caution-note');
            const modalForm = document.getElementById('caution-note-form');

            document.querySelectorAll('.caution-icon-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    const note = this.getAttribute('data-note');

                    modalNoteInput.value = note;
                    // Set form action dynamically. We assume URL pattern here or need a way to construct it.
                    // Best way: Use a placeholder or data attribute on the table row?
                    // Or construct it: /examinations/<id>/update-note/
                    // This assumes standard URL structure.
                    modalForm.action = `/examinations/${id}/update-note/`;

                    cautionNoteModal.show();
                });
            });
        }

        const selectAllCheckbox = document.getElementById('select-all');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const deleteBtn = document.getElementById('delete-selected-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteForm = document.getElementById('bulk-delete-form');
        const deleteList = document.getElementById('delete-confirmation-list');

        // Toggle Select All
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                itemCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateDeleteButtonState();
            });
        }

        // Individual checkbox change
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function () {
                updateDeleteButtonState();
                // Uncheck "select all" if any item is unchecked
                if (!this.checked && selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            });
        });

        function updateDeleteButtonState() {
            if (deleteBtn) {
                const anyChecked = Array.from(itemCheckboxes).some(cb => cb.checked);
                deleteBtn.disabled = !anyChecked;
            }
        }

        // Handle Delete Button Click
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function () {
                deleteList.innerHTML = ''; // Clear previous list
                const checkedBoxes = Array.from(itemCheckboxes).filter(cb => cb.checked);

                checkedBoxes.forEach(cb => {
                    const row = cb.closest('tr');
                    // Get the first data cell (usually Name or Date)
                    const firstDataCell = row.querySelector('td.item-data');
                    const itemText = firstDataCell ? firstDataCell.innerText.trim() : 'Kayƒ±t ' + cb.value;

                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = itemText;
                    deleteList.appendChild(li);
                });

                // Show Modal
                const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                modal.show();
            });
        }

        // Handle Confirm Delete
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function () {
                deleteForm.submit();
            });
        }
    });
</script>
{% endblock %}