{% extends 'core/base.html' %}

{% block content %}
<style>
    /* FORCE visibility - this rule beats base.html specificity */
    .card.border-info .topic-label-custom {
        background-color: var(--card-bg) !important;
        color: var(--foreground) !important;
        border: 1px solid var(--border-color) !important;
        border-left: 0 !important;
        border-right: 0 !important;
        flex: 1 1 auto !important;
        display: flex !important;
        align-items: center !important;
        padding: 0.375rem 0.75rem !important;
        cursor: pointer;
        overflow: hidden;
        white-space: nowrap;
    }
</style>

<div class="row mb-3">
    <div class="col">
        <h2>{{ title }}</h2>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" id="education-form">
            {% csrf_token %}

            <!-- Basic Info Section -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_date" class="form-label">Tarih</label>
                        {{ form.date }}
                        {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors.0 }}</div>{% endif
                        %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_workplace" class="form-label">İşyeri</label>
                        {{ form.workplace }}
                        {% if form.workplace.errors %}<div class="text-danger small">{{ form.workplace.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_topic" class="form-label">Eğitim Başlığı <small
                                class="text-muted">(opsiyonel)</small></label>
                        {{ form.topic }}
                        {% if form.topic.errors %}<div class="text-danger small">{{ form.topic.errors.0 }}</div>{% endif
                        %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_duration" class="form-label">Toplam Süre (Saat)</label>
                        {{ form.duration }}
                        {% if form.duration.errors %}<div class="text-danger small">{{ form.duration.errors.0 }}</div>{%
                        endif %}
                    </div>
                </div>
            </div>

            <!-- İBYS Fields -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Eğitim Yeri <span class="badge bg-info">İBYS</span></label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input type="radio" name="egitim_yeri" value="1" id="id_egitim_yeri_1"
                                class="form-check-input" {% if form.egitim_yeri.value==1 or form.egitim_yeri.value=='1'
                                or not form.egitim_yeri.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_egitim_yeri_1">İş Yerinde</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="egitim_yeri" value="0" id="id_egitim_yeri_0"
                                class="form-check-input" {% if form.egitim_yeri.value==0 or form.egitim_yeri.value=='0'
                                %}checked{% endif %}>
                            <label class="form-check-label" for="id_egitim_yeri_0">İş Yeri Dışında</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Eğitim Yöntemi <span class="badge bg-info">İBYS</span></label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input type="radio" name="egitim_yontemi" value="1" id="id_egitim_yontemi_1"
                                class="form-check-input" {% if form.egitim_yontemi.value==1 or
                                form.egitim_yontemi.value=='1' or not form.egitim_yontemi.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_egitim_yontemi_1">Yüz Yüze Eğitim</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="egitim_yontemi" value="0" id="id_egitim_yontemi_0"
                                class="form-check-input" {% if form.egitim_yontemi.value==0 or
                                form.egitim_yontemi.value=='0' %}checked{% endif %}>
                            <label class="form-check-label" for="id_egitim_yontemi_0">Uzaktan Eğitim</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Professionals -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_specialist" class="form-label">İş Güvenliği Uzmanı</label>
                        {{ form.specialist }}
                        {% if form.specialist.errors %}<div class="text-danger small">{{ form.specialist.errors.0 }}
                        </div>{% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_medic" class="form-label">İşyeri Hekimi / Sağlık Personeli</label>
                        {{ form.medic }}
                        {% if form.medic.errors %}<div class="text-danger small">{{ form.medic.errors.0 }}</div>{% endif
                        %}
                    </div>
                </div>
            </div>

            <!-- Education Topics Section (İBYS) -->
            <div class="card mb-3 border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <span style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#topicsCollapse"
                        aria-expanded="true">
                        <i class="bi bi-book"></i> Eğitim Konuları (İBYS) <i class="bi bi-chevron-down ms-2"
                            id="topicsChevron"></i>
                    </span>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="number" id="bulk-duration" class="form-control form-control-sm"
                            style="width: 80px;" value="30" min="1">
                        <button type="button" class="btn btn-sm btn-light" onclick="applyDurationToAll()">
                            <i class="bi bi-clock"></i> Tümüne Uygula
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="topicsCollapse">
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div class="row" id="topics-container">
                            {% for code, label in education_subjects %}
                            <div class="col-md-6 mb-2">
                                <div class="input-group input-group-sm">
                                    <div class="input-group-text">
                                        <input type="checkbox" name="topic_codes[]" value="{{ code }}"
                                            class="form-check-input topic-checkbox" id="topic_{{ code }}" {% if code in
                                            selected_topics %}checked{% endif %}>
                                    </div>
                                    <div class="topic-label-custom text-truncate"
                                        onclick="document.getElementById('topic_{{ code }}').click()">{{ label }}</div>
                                    <input type="number" name="topic_duration_{{ code }}"
                                        class="form-control topic-duration" style="max-width: 70px;" min="1" value="30"
                                        placeholder="dk" data-topic-code="{{ code }}">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workers -->
            <div class="mb-3">
                <label class="form-label">Katılımcılar</label>
                <div class="card p-2" style="max-height: 300px; overflow-y: auto;">
                    <div id="workers-checkbox-container">
                        {{ form.workers }}
                    </div>
                    <div id="no-workers-msg"
                        class="text-muted small text-center {% if form.workers.value or has_workplace %}d-none{% endif %}">
                        Lütfen önce bir işyeri seçiniz.
                    </div>
                </div>
                {% if form.workers.errors %}<div class="text-danger small">{{ form.workers.errors.0 }}</div>{% endif %}
            </div>

            <div class="d-flex justify-content-between">
                <div>
                    {% if education %}
                    <a href="{% url 'education_participation_form' education.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-file-earmark-pdf"></i> Katılım Formu İndir
                    </a>
                    {% endif %}
                </div>
                <div>
                    <a href="javascript:history.back()" class="btn btn-secondary me-2">İptal</a>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    var topicDurations = {{ topic_durations| safe }};

    document.addEventListener('DOMContentLoaded', function () {
        Object.keys(topicDurations).forEach(function (code) {
            var durationInput = document.querySelector('input[data-topic-code="' + code + '"]');
            if (durationInput) {
                durationInput.value = topicDurations[code];
            }
        });
    });

    function applyDurationToAll() {
        var duration = document.getElementById('bulk-duration').value;
        document.querySelectorAll('.topic-checkbox:checked').forEach(function (checkbox) {
            var code = checkbox.value;
            var durationInput = document.querySelector('input[name="topic_duration_' + code + '"]');
            if (durationInput) {
                durationInput.value = duration;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        var topicsCollapse = document.getElementById('topicsCollapse');
        var chevron = document.getElementById('topicsChevron');
        if (topicsCollapse && chevron) {
            topicsCollapse.addEventListener('hide.bs.collapse', function () { chevron.style.transform = 'rotate(-90deg)'; });
            topicsCollapse.addEventListener('show.bs.collapse', function () { chevron.style.transform = 'rotate(0deg)'; });
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        var workplaceSelect = document.getElementById('id_workplace');
        var workersContainer = document.getElementById('workers-checkbox-container');
        var noWorkersMsg = document.getElementById('no-workers-msg');

        if (workplaceSelect) {
            workplaceSelect.addEventListener('change', function () {
                var workplaceId = this.value;
                if (workplaceId) {
                    fetchWorkers(workplaceId);
                } else {
                    workersContainer.innerHTML = '';
                    noWorkersMsg.classList.remove('d-none');
                }
            });
        }

        function fetchWorkers(workplaceId) {
            workersContainer.innerHTML = '<div class="text-center py-2"><span class="spinner-border text-primary" role="status"></span></div>';
            noWorkersMsg.classList.add('d-none');

            fetch('{% url "get_workers_json" %}?workplace_id=' + workplaceId)
                .then(function (response) { return response.json(); })
                .then(function (data) {
                    workersContainer.innerHTML = '';
                    if (data.workers.length > 0) {
                        noWorkersMsg.classList.add('d-none');
                        data.workers.forEach(function (worker) {
                            var div = document.createElement('div');
                            div.className = 'form-check';
                            var input = document.createElement('input');
                            input.type = 'checkbox';
                            input.className = 'form-check-input';
                            input.name = 'workers';
                            input.value = worker.id;
                            input.id = 'id_workers_' + worker.id;
                            input.checked = true;
                            var label = document.createElement('label');
                            label.className = 'form-check-label';
                            label.htmlFor = 'id_workers_' + worker.id;
                            label.textContent = worker.name + ' (' + worker.tckn + ')';
                            div.appendChild(input);
                            div.appendChild(label);
                            workersContainer.appendChild(div);
                        });
                    } else {
                        noWorkersMsg.textContent = 'Bu işyerinde çalışan bulunamadı.';
                        noWorkersMsg.classList.remove('d-none');
                    }
                })
                .catch(function (error) { console.error('Error:', error); });
        }
    });
</script>
{% endblock %}