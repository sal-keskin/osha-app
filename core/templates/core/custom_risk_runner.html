{% extends 'core/base.html' %}

{% block content %}
<style>
    .assessment-container { display: flex; min-height: calc(100vh - 120px); margin: -1rem; }
    .assessment-sidebar { width: 300px; min-width: 300px; background: #f8f9fa; border-right: 1px solid #e9ecef; overflow-y: auto; max-height: calc(100vh - 120px); }
    .sidebar-header { padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 10; }
    .sidebar-header h5 { margin: 0; font-size: 1rem; font-weight: 600; }
    .sidebar-progress { margin-top: 0.5rem; }
    .sidebar-progress-bar { height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
    .sidebar-progress-fill { height: 100%; background: white; }
    .sidebar-progress-text { font-size: 0.75rem; opacity: 0.9; margin-top: 0.25rem; }
    .nav-category { border-bottom: 1px solid #e9ecef; }
    .nav-category-header { padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: #495057; background: #f1f3f5; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .nav-category-header:hover { background: #e9ecef; }
    .nav-topic { padding-left: 1rem; }
    .nav-topic-header { padding: 0.5rem 0.75rem; font-size: 0.8rem; font-weight: 500; color: #6c757d; }
    .nav-question { display: flex; align-items: center; padding: 0.5rem 0.75rem; font-size: 0.8rem; color: #495057; text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; }
    .nav-question:hover { background: #e9ecef; color: #495057; }
    .nav-question.active { background: #e7f1ff; border-left-color: #667eea; font-weight: 500; }
    .status-icon { width: 16px; height: 16px; border-radius: 50%; margin-right: 0.5rem; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .status-icon.unanswered { border: 2px solid #adb5bd; background: white; }
    .status-icon.yes { background: #28a745; color: white; }
    .status-icon.yes::after { content: '✓'; }
    .status-icon.no { background: #dc3545; color: white; }
    .status-icon.no::after { content: '✕'; }
    .status-icon.na { background: #6c757d; color: white; }
    .status-icon.na::after { content: '—'; }
    .nav-question-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .assessment-panel { flex: 1; padding: 2rem; overflow-y: auto; max-height: calc(100vh - 120px); }
    .question-card { max-width: 800px; margin: 0 auto; }
    .question-header { margin-bottom: 2rem; }
    .question-counter { font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; }
    .question-text { font-size: 1.5rem; font-weight: 600; color: #212529; line-height: 1.4; }
    .answer-options { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .answer-option { flex: 1; min-width: 200px; }
    .answer-option input[type="radio"] { display: none; }
    .answer-option label { display: flex; align-items: center; justify-content: center; padding: 1rem 1.5rem; border: 2px solid #e9ecef; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-weight: 500; background: white; }
    .answer-option label:hover { border-color: #adb5bd; }
    .answer-option input:checked+label { border-color: #667eea; background: #f0f4ff; }
    .answer-option.yes input:checked+label { border-color: #28a745; background: #d4edda; color: #155724; }
    .answer-option.no input:checked+label { border-color: #dc3545; background: #f8d7da; color: #721c24; }
    .risk-warning { padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 1.5rem; display: none; }
    .risk-warning.visible { display: block; }
    .question-footer { display: flex; justify-content: space-between; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
    .footer-left, .footer-right { display: flex; gap: 0.5rem; }
    .risk-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s; }
    .risk-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .risk-card-content { flex: 1; }
    .risk-card-title { font-weight: 500; margin-bottom: 0.25rem; }
    .risk-card-evidence { font-size: 0.85rem; color: #6c757d; }
    .empty-state { text-align: center; padding: 3rem; }
    .empty-state i { font-size: 4rem; color: #dee2e6; }
    @media (max-width: 991px) { .assessment-sidebar { display: none; } .assessment-sidebar.show { display: block; position: fixed; left: 0; top: 0; bottom: 0; z-index: 1050; width: 300px; } .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1040; } .sidebar-overlay.show { display: block; } }
</style>

<button class="btn btn-outline-secondary mb-3 d-lg-none" onclick="toggleSidebar()"><i class="bi bi-list"></i> Navigasyon</button>
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="assessment-container">
    <!-- SIDEBAR -->
    <div class="assessment-sidebar" id="assessmentSidebar">
        <div class="sidebar-header">
            <h5>{{ tool.title }}</h5>
            <div class="sidebar-progress">
                <div class="sidebar-progress-bar"><div class="sidebar-progress-fill" style="width: {{ progress_percentage }}%"></div></div>
                <div class="sidebar-progress-text">{{ total_questions }} soru</div>
            </div>
        </div>
        <div class="nav-tree">
            {% for category in categories_data %}
            <div class="nav-category">
                <div class="nav-category-header" data-bs-toggle="collapse" data-bs-target="#cat-{{ category.id }}"><i class="bi bi-chevron-down"></i> {{ category.title }}</div>
                <div class="collapse show" id="cat-{{ category.id }}">
                    {% for topic in category.topics %}
                    <div class="nav-topic">
                        <div class="nav-topic-header">{{ topic.title }}</div>
                        {% for q in topic.questions %}
                        <a href="{% url 'assessment_session_run' session.pk %}?q={{ q.id }}" class="nav-question" data-question-id="{{ q.id }}">
                            <span class="status-icon {{ q.status }}"></span>
                            <span class="nav-question-text">{{ q.content }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="nav-category" style="border-top: 2px solid #667eea;">
            <a href="{% url 'custom_risk_list' session.pk %}" class="nav-category-header active" style="background: #667eea; color: white;">
                <i class="bi bi-plus-circle"></i> Ek Riskler
                {% if custom_risks_count %}<span class="badge bg-light text-primary ms-auto">{{ custom_risks_count }}</span>{% endif %}
            </a>
            {% for cr in custom_risks %}
            <a href="{% url 'custom_risk_update' session.pk cr.pk %}" class="nav-question {% if view_mode == 'custom_edit' and custom_risk.pk == cr.pk %}active{% endif %}">
                <span class="status-icon {{ cr.status_class }}"></span>
                <span class="nav-question-text">Ω.{{ forloop.counter }} {{ cr.description|truncatechars:40 }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="assessment-panel">
        <div class="question-card">

            {% if view_mode == 'custom_list' %}
            <!-- LIST MODE -->
            <div class="question-header">
                <div class="question-counter"><i class="bi bi-plus-circle me-1"></i> Ek Riskler</div>
                <div class="question-text">Sahaya Özgü Riskler</div>
            </div>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                Standart değerlendirme sorularında yer almayan, tespit ettiğiniz ek riskleri buraya ekleyebilirsiniz.
            </div>

            {% if custom_risks %}
            {% for risk in custom_risks %}
            <div class="risk-card">
                <div class="d-flex align-items-center flex-grow-1">
                    <span class="status-icon {{ risk.status_class }} me-3"></span>
                    <div class="risk-card-content">
                        <div class="risk-card-title">Ω.{{ forloop.counter }} {{ risk.description }}</div>
                        {% if risk.evidence %}<div class="risk-card-evidence">{{ risk.evidence|truncatechars:80 }}</div>{% endif %}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'custom_risk_update' session.pk risk.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                    <a href="{% url 'custom_risk_delete' session.pk risk.pk %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="bi bi-shield-plus"></i>
                <h4 class="mt-3">Henüz ek risk eklenmedi</h4>
                <p class="text-muted">Tespit ettiğiniz sahaya özgü riskleri ekleyin.</p>
            </div>
            {% endif %}

            <div class="question-footer">
                <div class="footer-left">
                    <a href="{% url 'assessment_session_run' session.pk %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Değerlendirmeye Dön</a>
                </div>
                <div class="footer-right">
                    <a href="{% url 'custom_risk_create' session.pk %}" class="btn btn-primary btn-lg"><i class="bi bi-plus-lg me-1"></i> Ek Risk Ekle</a>
                </div>
            </div>

            {% elif view_mode == 'custom_add' or view_mode == 'custom_edit' %}
            <!-- ADD/EDIT MODE -->
            <div class="question-header">
                <div class="question-counter"><i class="bi bi-plus-circle me-1"></i> Ek Riskler</div>
                <div class="question-text">{{ title }}</div>
            </div>

            <form method="post">
                {% csrf_token %}
                
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-exclamation-triangle me-1"></i> Risk Tanımı *</label>
                    <textarea name="description" class="form-control" rows="3" placeholder="Tespit ettiğiniz riski açıklayın..." required>{% if form.instance.description %}{{ form.instance.description }}{% endif %}</textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Bu risk kabul edilebilir mi?</label>
                    <div class="answer-options">
                        <div class="answer-option yes">
                            <input type="radio" name="is_acceptable" id="acceptableYes" value="True" {% if form.instance.is_acceptable == True %}checked{% endif %}>
                            <label for="acceptableYes"><i class="bi bi-check-lg me-2"></i> Evet - Kabul Edilebilir</label>
                        </div>
                        <div class="answer-option no">
                            <input type="radio" name="is_acceptable" id="acceptableNo" value="False" {% if form.instance.is_acceptable == False %}checked{% endif %}>
                            <label for="acceptableNo"><i class="bi bi-x-lg me-2"></i> Hayır - Risk Mevcut</label>
                        </div>
                    </div>
                    <div class="risk-warning" id="riskWarning"><i class="bi bi-exclamation-triangle me-2"></i><strong>Dikkat:</strong> Bu risk Eylem Planına kaydedilecektir.</div>
                </div>

                <div class="mb-4">
                    <label class="form-label"><i class="bi bi-file-text me-1"></i> Bilgi / Kanıt</label>
                    <textarea name="evidence" class="form-control" rows="3" placeholder="Gözlemleriniz veya kanıtları ekleyin...">{% if form.instance.evidence %}{{ form.instance.evidence }}{% endif %}</textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label"><i class="bi bi-chat-left-text me-1"></i> Notlar (opsiyonel)</label>
                    <textarea name="notes" class="form-control" rows="2" placeholder="Ek notlar...">{% if form.instance.notes %}{{ form.instance.notes }}{% endif %}</textarea>
                </div>

                <div class="question-footer">
                    <div class="footer-left">
                        <a href="{% url 'custom_risk_list' session.pk %}" class="btn btn-outline-secondary">İptal</a>
                    </div>
                    <div class="footer-right">
                        <button type="submit" name="save" class="btn btn-success"><i class="bi bi-check2"></i> Kaydet</button>
                        {% if view_mode == 'custom_add' %}
                        <button type="submit" name="save_another" class="btn btn-primary">Kaydet & Yeni Ekle <i class="bi bi-plus-lg"></i></button>
                        {% endif %}
                    </div>
                </div>
            </form>

            {% elif view_mode == 'custom_delete' %}
            <!-- DELETE MODE -->
            <div class="question-header">
                <div class="question-counter"><i class="bi bi-trash me-1"></i> Ek Risk Sil</div>
                <div class="question-text">{{ object.description|truncatechars:60 }}</div>
            </div>

            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Dikkat!</strong> Bu işlem geri alınamaz. Bu ek riski silmek istediğinizden emin misiniz?
            </div>

            <form method="post">
                {% csrf_token %}
                <div class="question-footer">
                    <div class="footer-left">
                        <a href="{% url 'custom_risk_list' session.pk %}" class="btn btn-outline-secondary">İptal</a>
                    </div>
                    <div class="footer-right">
                        <button type="submit" class="btn btn-danger"><i class="bi bi-trash"></i> Sil</button>
                    </div>
                </div>
            </form>
            {% endif %}

        </div>
    </div>
</div>

<script>
function toggleSidebar() {
    document.getElementById('assessmentSidebar').classList.toggle('show');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
}

document.querySelectorAll('input[name="is_acceptable"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        document.getElementById('riskWarning').classList.toggle('visible', this.value === 'False');
    });
});

var checked = document.querySelector('input[name="is_acceptable"]:checked');
if (checked && checked.value === 'False') document.getElementById('riskWarning').classList.add('visible');
</script>
{% endblock %}
