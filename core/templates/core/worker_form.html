{% extends 'core/base.html' %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>{{ title }}</h2>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            {% for field in form %}
                <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>

                    {% if field.name == 'profession' %}
                        <div class="input-group">
                            {{ field }}
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addProfessionModal">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    {% elif field.name == 'chronic_diseases_list' %}
                         <div class="card p-2">
                            {{ field }}
                         </div>
                    {% else %}
                        {{ field }}
                    {% endif %}

                    {% if field.errors %}
                        <div class="text-danger small mt-1">
                            {{ field.errors.0 }}
                        </div>
                    {% endif %}
                    {% if field.help_text %}
                        <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                </div>
            {% endfor %}

            <div class="d-flex justify-content-end">
                <a href="javascript:history.back()" class="btn btn-secondary me-2">İptal</a>
                <button type="submit" class="btn btn-primary">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Profession Modal -->
<div class="modal fade" id="addProfessionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yeni Meslek Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="new_profession_name" class="form-label">Meslek Adı</label>
            <input type="text" class="form-control" id="new_profession_name">
            <div id="profession-error" class="text-danger small mt-1 d-none"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-primary" id="save-profession-btn">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-profession-btn');
    const nameInput = document.getElementById('new_profession_name');
    const errorDiv = document.getElementById('profession-error');
    const selectBox = document.getElementById('id_profession');
    const modalElement = document.getElementById('addProfessionModal');
    const modal = new bootstrap.Modal(modalElement);
    
    // Facility Logic
    const workplaceSelect = document.getElementById('id_workplace');
    const facilitySelect = document.getElementById('id_facility');

    if (workplaceSelect && facilitySelect) {
        // Initial check: if no workplace selected, disable facility
        if (!workplaceSelect.value) {
            facilitySelect.disabled = true;
        }

        workplaceSelect.addEventListener('change', function() {
            const workplaceId = this.value;
            facilitySelect.disabled = !workplaceId;
            
            // Clear facilities
            facilitySelect.innerHTML = '<option value="">---------</option>';
            
            if (workplaceId) {
                fetch(`{% url 'api_get_facilities' %}?workplace_id=${workplaceId}`)
                .then(response => response.json())
                .then(data => {
                    data.facilities.forEach(facility => {
                        const option = document.createElement('option');
                        option.value = facility.id;
                        option.textContent = facility.name;
                        facilitySelect.appendChild(option);
                    });
                    
                    // Add "New Facility" option
                    const newOption = document.createElement('option');
                    newOption.value = 'NEW';
                    newOption.textContent = '+ Yeni Birim Ekle...';
                    newOption.style.fontWeight = 'bold';
                    facilitySelect.appendChild(newOption);
                });
            }
        });

        facilitySelect.addEventListener('change', function() {
            if (this.value === 'NEW') {
                const workplaceId = workplaceSelect.value;
                if (!workplaceId) {
                    alert('Lütfen önce bir işyeri seçiniz.');
                    this.value = '';
                    return;
                }
                
                const name = prompt("Yeni Birim Adı:");
                if (name) {
                    fetch('{% url "api_create_facility" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ name: name, workplace_id: workplaceId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const option = document.createElement('option');
                            option.value = data.facility.id;
                            option.textContent = data.facility.name;
                            option.selected = true;
                            // Insert before the last option (which is + Yeni Birim Ekle)
                            this.insertBefore(option, this.lastElementChild);
                        } else {
                            alert('Hata: ' + data.error);
                            this.value = '';
                        }
                    });
                } else {
                    this.value = '';
                }
            }
        });
    }

    saveBtn.addEventListener('click', function() {
        const name = nameInput.value.trim();
        if (!name) {
            showError('Lütfen bir meslek adı giriniz.');
            return;
        }

        // Loading state
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Kaydediliyor...';

        // AJAX request to create profession
        fetch('{% url "api_create_profession" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ name: name })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new option to select box and select it
                const option = new Option(data.profession.name, data.profession.id);
                selectBox.add(option, undefined);
                selectBox.value = data.profession.id;

                // Close modal and reset
                modal.hide();
                nameInput.value = '';
                errorDiv.classList.add('d-none');
            } else {
                showError(data.error || 'Bir hata oluştu.');
            }
        })
        .catch(error => {
            showError('Sunucu hatası: ' + error);
        })
        .finally(() => {
            // Restore button
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        });
    });

    function showError(msg) {
        errorDiv.textContent = msg;
        errorDiv.classList.remove('d-none');
    }
});
</script>
{% endblock %}
