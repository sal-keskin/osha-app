{% extends 'core/base.html' %}

{% block content %}
<style>
    .assessment-container { display: flex; min-height: calc(100vh - 120px); margin: -1rem; }
    .assessment-sidebar { width: 300px; min-width: 300px; background: #f8f9fa; border-right: 1px solid #e9ecef; overflow-y: auto; max-height: calc(100vh - 120px); }
    .sidebar-header { padding: 1rem; background: linear-gradient(135deg, #fd7e14 0%, #dc3545 100%); color: white; position: sticky; top: 0; z-index: 10; }
    .sidebar-header h5 { margin: 0; font-size: 1rem; font-weight: 600; }
    .sidebar-header .subtitle { font-size: 0.75rem; opacity: 0.9; margin-top: 0.25rem; }
    .nav-section { padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; color: #667eea; background: #f1f3f5; text-transform: uppercase; letter-spacing: 0.5px; }
    .nav-risk { display: flex; align-items: center; padding: 0.75rem 1rem; font-size: 0.85rem; color: #495057; text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; border-bottom: 1px solid #e9ecef; }
    .nav-risk:hover { background: #e9ecef; color: #495057; }
    .nav-risk.active { background: #fff3cd; border-left-color: #fd7e14; }
    .risk-status { width: 12px; height: 12px; border-radius: 50%; margin-right: 0.75rem; flex-shrink: 0; }
    .risk-status.no_measures { background: #dc3545; }
    .risk-status.incomplete { background: #fd7e14; }
    .risk-status.complete { background: #28a745; }
    .nav-risk-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .nav-risk-badge { font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 10px; background: #e9ecef; color: #6c757d; }
    .assessment-panel { flex: 1; padding: 2rem; overflow-y: auto; max-height: calc(100vh - 120px); }
    .question-card { max-width: 900px; margin: 0 auto; }
    .risk-header { padding: 1.5rem; background: linear-gradient(135deg, #fff3cd 0%, #ffe5b4 100%); border: 2px solid #fd7e14; border-radius: 12px; margin-bottom: 2rem; }
    .risk-title { font-size: 1.25rem; font-weight: 600; color: #212529; margin-bottom: 0.5rem; }
    .risk-counter { font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; }
    .priority-selector { display: inline-flex; align-items: center; gap: 0.5rem; background: white; padding: 0.5rem 1rem; border-radius: 8px; margin-top: 0.5rem; }
    .priority-selector select { padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 500; }
    .original-answer { font-size: 0.85rem; color: #6c757d; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(0,0,0,0.1); }
    .read-more-link { font-size: 0.85rem; color: #0d6efd; cursor: pointer; }
    .measure-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden; }
    .measure-header { padding: 1rem 1.5rem; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e9ecef; }
    .measure-header h5 { margin: 0; font-size: 0.95rem; font-weight: 500; }
    .measure-header .collapsed-info { font-size: 0.8rem; color: #6c757d; }
    .measure-body { padding: 1.5rem; }
    .measure-actions { display: flex; gap: 0.5rem; }
    .add-measure-btns { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
    .add-measure-btns .btn { flex: 1; min-width: 200px; padding: 1rem; }
    .intro-hero { text-align: center; padding: 3rem 2rem; }
    .intro-hero i { font-size: 5rem; color: #fd7e14; }
    .intro-steps { display: flex; gap: 1.5rem; margin-top: 2rem; flex-wrap: wrap; }
    .intro-step { flex: 1; min-width: 200px; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; text-align: center; }
    .intro-step .step-num { width: 40px; height: 40px; background: #667eea; color: white; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 0.75rem; }
    .question-footer { display: flex; justify-content: space-between; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; margin-top: 2rem; }
    .footer-left, .footer-right { display: flex; gap: 0.5rem; }
    @media (max-width: 991px) { .assessment-sidebar { display: none; } .assessment-sidebar.show { display: block; position: fixed; left: 0; top: 0; bottom: 0; z-index: 1050; width: 300px; } }
</style>

<button class="btn btn-outline-secondary mb-3 d-lg-none" onclick="toggleSidebar()"><i class="bi bi-list"></i> Riskler</button>
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="assessment-container">
    <!-- SIDEBAR -->
    <div class="assessment-sidebar" id="assessmentSidebar">
        <div class="sidebar-header">
            <h5><i class="bi bi-clipboard-check me-2"></i>Eylem Planı</h5>
            <div class="subtitle">{{ total_risks }} risk önlem bekliyor</div>
        </div>

        {% if standard_risks %}
        <div class="nav-section">Standart Riskler</div>
        {% for risk in standard_risks %}
        <a href="{% url 'action_plan_edit' session.pk risk.type risk.id %}" class="nav-risk {% if current_risk.type == risk.type and current_risk.id == risk.id %}active{% endif %}">
            <span class="risk-status {{ risk.status }}"></span>
            <span class="nav-risk-text">{{ risk.title }}</span>
            {% if risk.measures_count %}<span class="nav-risk-badge">{{ risk.measures_count }}</span>{% endif %}
        </a>
        {% endfor %}
        {% endif %}

        {% if custom_risks_no %}
        <div class="nav-section">Ek Riskler</div>
        {% for risk in custom_risks_no %}
        <a href="{% url 'action_plan_edit' session.pk risk.type risk.id %}" class="nav-risk {% if current_risk.type == risk.type and current_risk.id == risk.id %}active{% endif %}">
            <span class="risk-status {{ risk.status }}"></span>
            <span class="nav-risk-text">Ω {{ risk.title }}</span>
            {% if risk.measures_count %}<span class="nav-risk-badge">{{ risk.measures_count }}</span>{% endif %}
        </a>
        {% endfor %}
        {% endif %}

        <div style="padding: 1rem;">
            <a href="{% url 'assessment_session_run' session.pk %}" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-arrow-left"></i> Değerlendirmeye Dön</a>
            <a href="{% url 'assessment_status' session.pk %}" class="btn btn-outline-primary btn-sm w-100 mt-2"><i class="bi bi-speedometer2"></i> Durum</a>
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="assessment-panel">
        <div class="question-card">

            {% if view_mode == 'intro' %}
            <!-- INTRO MODE -->
            <div class="intro-hero">
                <i class="bi bi-clipboard-check"></i>
                <h2 class="mt-3">Eylem Planı</h2>
                <p class="text-muted lead">Değerlendirmeniz tamamlandı! Şimdi tespit edilen risklere önlem tanımlayın.</p>
            </div>

            <div class="intro-steps">
                <div class="intro-step">
                    <div class="step-num">1</div>
                    <h5>Risk Seçin</h5>
                    <p class="text-muted small">Sol menüden bir risk seçerek başlayın.</p>
                </div>
                <div class="intro-step">
                    <div class="step-num">2</div>
                    <h5>Öncelik Belirleyin</h5>
                    <p class="text-muted small">Riskin önceliğini (Yüksek/Orta/Düşük) seçin.</p>
                </div>
                <div class="intro-step">
                    <div class="step-num">3</div>
                    <h5>Önlem Ekleyin</h5>
                    <p class="text-muted small">Sorumlu, bütçe ve tarih bilgilerini girin.</p>
                </div>
            </div>

            {% if total_risks == 0 %}
            <div class="alert alert-success mt-4 text-center">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Tebrikler!</strong> Önlem gerektiren risk bulunmuyor.
            </div>
            <div class="text-center mt-3">
                <a href="{% url 'assessment_report' session.pk %}" class="btn btn-primary btn-lg"><i class="bi bi-file-earmark-text me-1"></i> Raporlamaya Geç</a>
            </div>
            {% else %}
            <div class="text-center mt-4">
                {% if standard_risks %}
                <a href="{% url 'action_plan_edit' session.pk standard_risks.0.type standard_risks.0.id %}" class="btn btn-primary btn-lg"><i class="bi bi-play-fill me-1"></i> İlk Riskle Başla</a>
                {% elif custom_risks_no %}
                <a href="{% url 'action_plan_edit' session.pk custom_risks_no.0.type custom_risks_no.0.id %}" class="btn btn-primary btn-lg"><i class="bi bi-play-fill me-1"></i> İlk Riskle Başla</a>
                {% endif %}
            </div>
            {% endif %}

            {% elif view_mode == 'list' %}
            <!-- LIST MODE -->
            <h2 class="mb-4"><i class="bi bi-clipboard-check me-2"></i>Eylem Planı</h2>
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                Soldaki listeden bir risk seçerek önlem eklemeye başlayın.
            </div>

            {% if total_risks == 0 %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle" style="font-size: 4rem; color: #28a745;"></i>
                <h4 class="mt-3">Tebrikler!</h4>
                <p class="text-muted">Önlem gerektiren risk bulunmuyor.</p>
                <a href="{% url 'assessment_report' session.pk %}" class="btn btn-primary">Raporlamaya Geç</a>
            </div>
            {% endif %}

            {% elif view_mode == 'edit' %}
            <!-- EDIT MODE -->
            
            <!-- Risk Header -->
            <div class="risk-header">
                <div class="risk-counter">Risk {{ risk_index }} / {{ total_risks }}</div>
                <div class="risk-title"><i class="bi bi-exclamation-triangle me-2"></i>{{ risk_title }}</div>
                
                <div class="priority-selector">
                    <label class="mb-0">Bu</label>
                    <select id="prioritySelect" onchange="updatePriority(this.value)">
                        <option value="" {% if not priority %}selected{% endif %}>- Seç -</option>
                        <option value="HIGH" {% if priority == "HIGH" %}selected{% endif %}>Yüksek</option>
                        <option value="MEDIUM" {% if priority == "MEDIUM" %}selected{% endif %}>Orta</option>
                        <option value="LOW" {% if priority == "LOW" %}selected{% endif %}>Düşük</option>
                    </select>
                    <label class="mb-0">öncelikli bir risktir.</label>
                </div>

                {% if original_notes %}
                <div class="original-answer">
                    <i class="bi bi-chat-quote me-1"></i> <strong>Notlar:</strong> {{ original_notes }}
                </div>
                {% endif %}

                {% if risk_info %}
                <div class="mt-2">
                    <a class="read-more-link" data-bs-toggle="collapse" href="#riskInfo"><i class="bi bi-info-circle me-1"></i> Risk hakkında bilgi</a>
                    <div class="collapse mt-2" id="riskInfo">
                        <div class="alert alert-light mb-0 small">{{ risk_info|linebreaks }}</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Measures Section -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0"><i class="bi bi-tools me-2"></i>Önlemler</h4>
                <span class="badge bg-secondary">{{ measures.count }} önlem</span>
            </div>

            {% if measures %}
            {% for measure in measures %}
            <div class="measure-card">
                <div class="measure-header" data-bs-toggle="collapse" data-bs-target="#measure{{ measure.id }}">
                    <div>
                        <h5><i class="bi bi-chevron-down me-2"></i>Önlem {{ forloop.counter }}</h5>
                        <div class="collapsed-info">
                            {% if measure.responsible_person %}{{ measure.responsible_person }}{% endif %}
                            {% if measure.planning_end_date %} • {{ measure.planning_end_date|date:"d.m.Y" }}{% endif %}
                        </div>
                    </div>
                    <div class="measure-actions" onclick="event.stopPropagation();">
                        <form method="post" action="{% url 'measure_delete' session.pk measure.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bu önlemi silmek istediğinizden emin misiniz?')"><i class="bi bi-trash"></i></button>
                        </form>
                    </div>
                </div>
                <div class="collapse show" id="measure{{ measure.id }}">
                    <div class="measure-body">
                        <form method="post" action="{% url 'measure_update' session.pk measure.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">Önlem Açıklaması</label>
                                <textarea name="description" class="form-control" rows="2">{{ measure.description }}</textarea>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Gerekli Uzmanlık</label>
                                    <input type="text" name="expertise" class="form-control" value="{{ measure.expertise }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sorumlu Kişi</label>
                                    <input type="text" name="responsible_person" class="form-control" value="{{ measure.responsible_person }}">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Bütçe</label>
                                    <input type="text" name="budget" class="form-control" value="{{ measure.budget }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Başlangıç</label>
                                    <input type="date" name="planning_start_date" class="form-control" value="{{ measure.planning_start_date|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Bitiş</label>
                                    <input type="date" name="planning_end_date" class="form-control" value="{{ measure.planning_end_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-check2"></i> Değişiklikleri Kaydet</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle me-2"></i>
                Bu risk için henüz önlem eklenmedi. Aşağıdaki butonlarla önlem ekleyebilirsiniz.
            </div>
            {% endif %}

            <!-- Add Measure Buttons -->
            <div class="add-measure-btns">
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#standardMeasuresModal">
                    <i class="bi bi-list-check me-2"></i> Standart Önlem Seç
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#newMeasureForm">
                    <i class="bi bi-plus-lg me-2"></i> Önleyici Önlem Ekle
                </button>
            </div>

            <!-- New Measure Form -->
            <div class="collapse mt-3" id="newMeasureForm">
                <div class="measure-card">
                    <div class="measure-header" style="background: #e7f1ff;">
                        <h5><i class="bi bi-plus-circle me-2"></i>Yeni Önlem</h5>
                    </div>
                    <div class="measure-body">
                        <form method="post" action="{% url 'measure_add' session.pk risk_type risk_id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label fw-bold">Önlem Açıklaması *</label>
                                <textarea name="description" class="form-control" rows="2" placeholder="Riski ortadan kaldırmak için genel yaklaşım..." required></textarea>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Gerekli Uzmanlık</label>
                                    <input type="text" name="expertise" class="form-control" placeholder="Örn: İş Güvenliği Uzmanı">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Sorumlu Kişi</label>
                                    <input type="text" name="responsible_person" class="form-control" placeholder="İsim veya pozisyon">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Bütçe</label>
                                    <input type="text" name="budget" class="form-control" placeholder="Örn: 5.000 TL">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Başlangıç</label>
                                    <input type="date" name="planning_start_date" class="form-control">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Bitiş</label>
                                    <input type="date" name="planning_end_date" class="form-control">
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#newMeasureForm">İptal</button>
                                <button type="submit" class="btn btn-success"><i class="bi bi-plus-lg"></i> Önlem Ekle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Navigation Footer -->
            <div class="question-footer">
                <div class="footer-left">
                    {% if prev_risk %}
                    <a href="{% url 'action_plan_edit' session.pk prev_risk.type prev_risk.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-chevron-left"></i> Önceki Risk
                    </a>
                    {% endif %}
                </div>
                <div class="footer-right">
                    {% if next_risk %}
                    <a href="{% url 'action_plan_edit' session.pk next_risk.type next_risk.id %}" class="btn btn-dark">
                        Sonraki Risk <i class="bi bi-chevron-right"></i>
                    </a>
                    {% else %}
                    <a href="{% url 'assessment_report' session.pk %}" class="btn btn-success">
                        <i class="bi bi-file-earmark-text"></i> Raporlamaya Geç
                    </a>
                    {% endif %}
                </div>
            </div>

            {% endif %}

        </div>
    </div>
</div>

<!-- Standard Measures Modal -->
<div class="modal fade" id="standardMeasuresModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-list-check me-2"></i>Standart Önlemler</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Standart önlem kütüphanesi henüz hazırlanmaktadır. Şimdilik manuel önlem ekleyebilirsiniz.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSidebar() {
    document.getElementById('assessmentSidebar').classList.toggle('show');
    var overlay = document.querySelector('.sidebar-overlay');
    if (overlay) overlay.classList.toggle('show');
}

{% if view_mode == 'edit' %}
function updatePriority(value) {
    fetch('{% url "action_plan_priority_update" session.pk risk_type risk_id %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ priority: value })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        if (data.success) {
            var select = document.getElementById('prioritySelect');
            select.style.borderColor = '#28a745';
            setTimeout(function() { select.style.borderColor = ''; }, 1000);
        }
    })
    .catch(function(err) { console.error(err); });
}
{% endif %}
</script>
{% endblock %}
